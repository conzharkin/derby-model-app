import streamlit as st
import pandas as pd

st.set_page_config(page_title="Derby Model App", layout="wide")

st.title("🏇 Derby 2025 – Horse Racing Intelligence Model")
st.markdown("Upload your race data to see form, stamina, step-up suitability, and value angles.")

uploaded_file = st.file_uploader("Upload your race card CSV", type=["csv"])

if uploaded_file is not None:
    df = pd.read_csv(uploaded_file)

    # Display main data table
    st.subheader("📋 Full Model Output")
    st.dataframe(df, use_container_width=True)

    # Filters
    with st.expander("🔍 Filters"):
        trip = st.selectbox("Filter by Step-Up Suitability", ["All"] + sorted(df["Step-Up Suitability"].unique()))
        ground = st.selectbox("Filter by Softer Ground?", ["All"] + sorted(df["Softer Ground?"].unique()))
        pedigree = st.selectbox("Filter by Pedigree Stamina Flag", ["All"] + sorted(df["Pedigree Stamina Flag"].unique()))

        filtered_df = df.copy()
        if trip != "All":
            filtered_df = filtered_df[filtered_df["Step-Up Suitability"] == trip]
        if ground != "All":
            filtered_df = filtered_df[filtered_df["Softer Ground?"] == ground]
        if pedigree != "All":
            filtered_df = filtered_df[filtered_df["Pedigree Stamina Flag"] == pedigree]

        st.dataframe(filtered_df, use_container_width=True)

    # Summary logic (e.g. Best Value, Top Rated)
    st.subheader("🏆 Model Verdicts")
    if not df.empty:
        best_value = df.sort_values(by="Delta", ascending=False).head(1)
        st.markdown(f"**💰 Best Value Bet:** `{best_value.iloc[0]['Horse']}` (Delta: {best_value.iloc[0]['Delta']})")

        top_stayer = df[df["Pedigree Stamina Flag"] == "✅"].sort_values(by="Delta", ascending=False).head(1)
        st.markdown(f"**🧬 Best Stayer on Pedigree:** `{top_stayer.iloc[0]['Horse']}`")

else:
    st.info("Please upload a CSV file to see the model in action.")
